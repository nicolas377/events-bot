const Discord=require("discord.js"),client=new Discord.Client,CryptoJS=require("crypto-js"),fs=require("fs");var users=[],codes=[],pics=null,removing=null;function convertMiliseconds(e,t){var n,s,o,a,r,i,d;switch(d=parseInt(Math.floor(e/1e3)),i=parseInt(Math.floor(d/60)),r=parseInt(Math.floor(i/60)),n=parseInt(Math.floor(r/24)),a=parseInt(d%60),o=parseInt(i%60),s=parseInt(r%24),t){case"s":return d;case"m":return i;case"h":return r;case"d":return n;default:return{d:n,h:s,m:o,s:a}}}function avatar(e){if(null==e.mentions.users.first())var t=e.author;else t=e.mentions.users.first();const n=new Discord.MessageEmbed;n.setColor(3355443),n.setAuthor(t.tag),n.setImage(t.displayAvatarURL({format:"png",dynamic:!0,size:2048})),e.channel.send(n)}function codeMsg(e){var t=randomString();codes.includes(t)&&(t=randomString());const n=pics[Math.floor(Math.random()*pics.length)];return msg1=`**ELECTION INSTRUCTIONS**\nStep 1: Copy this ${"```"+t+"```"}\nStep 2: Go to this link. <https://docs.google.com/forms/d/e/1FAIpQLSfG3-Hoa0cydMMPNS3i62k_WSDiVfmnLs5jnKDfNCjcJ5_eAA/viewform>\n\nStep 3: Follow the prompts in the form`,e.author.send(msg1),e.author.send(n),t}function help(e,t){const n=new Discord.MessageEmbed;n.setColor("#0099ff"),n.setTitle("Events Bot Help"),n.setURL("https://www.youtube.com/watch?v=dQw4w9WgXcQ"),n.setAuthor(e.author.tag),n.addFields({name:"\n$ping",value:"Gets the latency from message sending to message repsonse"},{name:"$av",value:"Gets the avatar of the mentioned user if they're in the server. Defaults to the person sending the msg."},{name:"$membercount",value:"Replies with the number of members in the server."}),t&&n.addField("$code","Election command. DM's the user the election code, along with the instructions for to vote."),e.member.roles.cache.some(e=>"Bot mod"===e.name)&&(n.addField("$approve","Gives a user in the waiting room the Junior Pilot role and sends a welcome message."),n.addField("$questioning","Logs all the roles of the user, then overwrites the user's roles with the questioning role."),n.addField("$addimage","Adds a new image to the bot's reserves. Requires a file attachment.")),n.addField("$help","This command."),n.setImage(pics[Math.floor(Math.random()*pics.length)]),n.setTimestamp(),e.channel.send(n)}function randomString(e=64){for(var t="",n=e;n>0;--n)num=Math.floor(94*Math.random()+33),t+=String.fromCharCode(num);return t}async function ping(e){let t=await e.channel.send("Loading...");var n=`:ping_pong: Pong!\nLatency is ${t.createdTimestamp-e.createdTimestamp}ms.\nAPI Latency is ${Math.round(client.ws.ping)} ms`;t.edit(n)}function filter(e){"760831152109649940"!=e.channel.id&&(words=e.content.split(" "),words.forEach(t=>{var n=t.replace(/([^a-zA-z0-9]+)/g,"").toLowerCase();if(removing.includes(n))return e.delete(),e.channel.send(`<@${e.author.id}>, watch your language!`)}))}function readJSON(){var e=fs.readFileSync("json/main.json");return(e=JSON.parse(e)).election.users.forEach(function(e){var t=CryptoJS.AES.decrypt(e,process.env.ENCRYPTION_KEY);users.push(t.toString(CryptoJS.enc.Utf8))}),e.election.codes.forEach(function(e){var t=CryptoJS.AES.decrypt(e,process.env.ENCRYPTION_KEY);codes.push(t.toString(CryptoJS.enc.Utf8))}),pics=e.images,removing=e.filterlist,"JSON file read"}function saveJSON(){var e={election:{users:[],codes:[]},images:[],filterlist:[]};e.images=pics,e.filterlist=removing,users.forEach(function(t){var n=CryptoJS.AES.encrypt(t,process.env.ENCRYPTION_KEY);e.election.users.push(n.toString())}),codes.forEach(function(t){var n=CryptoJS.AES.encrypt(t,process.env.ENCRYPTION_KEY);e.election.codes.push(n.toString())}),fs.writeFileSync("json/main.json",JSON.stringify(e))}function getMemberNumber(){return client.guilds.cache.get("553718744233541656").memberCount-7}function getDateObject(e){data=convertMiliseconds(e);var t={y:null,m:null,w:null,d:null,h:null,mi:null,s:null};return t.s=data.s,t.mi=data.m,t.h=data.h,data=(e=>{let t=0,n=0,s=0,o=0;for(;e;)e>=365?(n++,e-=365):e>=30?(t++,e-=30):e>=7?(o++,e-=7):(s++,e--);return{y:n,m:t,w:o,d:s}})(data.d),t.d=data.d,t.w=data.w,t.m=data.m,t.y=data.y,t}function timeHandler(e){return dataobj=getDateObject(e),dataobj.y>0?`Years: ${dataobj.y}, Months: ${dataobj.m}, Weeks: ${dataobj.w}, Days: ${dataobj.d}, Hours: ${dataobj.h}, Minutes: ${dataobj.mi}, Seconds: ${dataobj.s}`:dataobj.m>0?`Months: ${dataobj.m}, Weeks: ${dataobj.w}, Days: ${dataobj.d}, Hours: ${dataobj.h}, Minutes: ${dataobj.mi}, Seconds: ${dataobj.s}`:dataobj.w>0?`Weeks: ${dataobj.w}, Days: ${dataobj.d}, Hours: ${dataobj.h}, Minutes: ${dataobj.mi}, Seconds: ${dataobj.s}`:dataobj.d>0?`Days: ${dataobj.d}, Hours: ${dataobj.h}, Minutes: ${dataobj.mi}, Seconds: ${dataobj.s}`:dataobj.h>0?`Hours: ${dataobj.h}, Minutes: ${dataobj.mi}, Seconds: ${dataobj.s}`:`Minutes: ${dataobj.mi}, Seconds: ${dataobj.s}`}client.on("ready",()=>{client.user.setActivity("$help | Vote or else",{type:"PLAYING"})}),client.on("guildMemberRemove",e=>{var t=new Discord.MessageEmbed;t.setColor("#0099ff"),t.setAuthor("Member Left"),t.setDescription(`${e} ${e.user.tag}`),t.setFooter(`ID: ${e.id}`),t.setTimestamp(),client.channels.cache.get("753568398440398969").send(t)}),client.on("guildMemberAdd",e=>{existed=Date.now()-e.user.createdAt,existed=timeHandler(existed),e.roles.set(["752701923399958610","553723645265182720"]),ageembed=new Discord.MessageEmbed,ageembed.setColor("#0099ff"),ageembed.setAuthor("Member Joined"),ageembed.setDescription(`${e} ${e.user.tag}`),ageembed.addField("**Account Age**",`${existed}`),ageembed.setFooter(`ID: ${e.id}`),ageembed.setTimestamp(),client.channels.cache.get("753568398440398969").send(ageembed),client.channels.cache.get("553733333234876426").send(`Welcome to GeoFS Events ${e}! Please read the <#553929583397961740> and <#553720929063141379>, and then ping an online Elite Crew member to let you in!`)}),client.on("message",async e=>{if(!e.author.bot){await filter(e);try{void 0!==typeof e.mentions.members.first()&&"780458120605990954"===e.mentions.members.first().user.id&&(newmsg="Hello! My command prefix is `$`\nIf you want to get a list of commands you can run `$help`",e.channel.send(newmsg))}catch(e){}if(e.content.startsWith("$")){if(e.member.roles.cache.some(e=>"Junior Pilot"===e.name))var t=!1;else t=!0;if(e.content.startsWith("$restart")||e.content.startsWith("$reload"))return"550456900861427733"==e.author.id&&(await e.channel.send("Restarting. See you soon!"),process.exit()),e.channel.send(`<@${e.author.id}>, you can't restart me!`);if(e.content.startsWith("$ping"))ping(e);else if(e.content.startsWith("$av"))avatar(e);else if(e.content.startsWith("$help"))help(e,t);else{if(e.content.startsWith("$membercount")&&e.channel.send(`There are ${getMemberNumber()} members in the server.`),e.content.startsWith("$code"))return t?users.includes(e.author.id)?e.channel.send(`<@${e.author.id}>, you've already gotten a code!`):(code=codeMsg(e),codes.push(code),users.push(e.author.id),saveJSON(),e.channel.send(`<@${e.author.id}>, check your dm's for instructions!`)):e.channel.send(`<@${e.author.id}>, you can't vote right now!`);if(e.content.startsWith("$approve")){if(e.member.roles.cache.has("766386531681435678")){if(null==e.mentions.members.first())return e.channel.send(`<@${e.author.id}>, you have to mention someone!`);let t=e.mentions.members.first();if(t.roles.cache.some(e=>"Security Check"===e.name)){t.roles.set(["553723642568114187"]);var n=`Welcome to GeoFS Events ${t}!\nWe hope you enjoy your stay!\nPlease make sure you have read <#553929583397961740> and <#553720929063141379>.\nWe organize and host events every day, so make sure to check <#756937922904850442> to keep up on events hosted for that day.\nThere are currently ${getMemberNumber()} people in this server.\nIf you need any help or advice, contact the Elite Crew.\nUse <#717777238979903566> to put your event ideas in and we will do it as soon as possible!\n\nCheck out and subscribe to our channel here: <https://www.youtube.com/channel/UCZhJvrv8C6mb0FXENg6uh2w>`;return client.channels.cache.get("553718744657035274").send(n),e.channel.send("User approved sucessfully")}return e.channel.send("That didn't work.")}return e.channel.send(`<@${e.author.id}>, you can't run that command!`)}if(e.content.startsWith("$questioning")){if(e.member.roles.cache.has("766386531681435678")){if(null==e.mentions.members.first())return e.channel.send(`<@${e.author.id}>, you have to mention someone!`);let t=e.mentions.members.first();if(t.roles.cache.has("766386531681435678"))return e.channel.send("That user can't be sent to the questioning room!");{let n=[];return t.roles.member._roles.forEach(function(t){let s=e.guild.roles.cache.get(t);n.push(s.name)}),client.channels.cache.get("760831152109649940").send(`${t} had roles ${n.join(", ")}`),t.roles.set(["762663566531624980"]),client.channels.cache.get("767050317362757741").send(`<@${t.id}>, you've been sent to the questioning room.`),e.channel.send(`${t} has been sent to the questioning room`)}}return e.channel.send(`<@${e.author.id}>, you can't run that command!`)}}}}}),client.on("error",e=>console.error(e)),client.on("warn",e=>console.warn(e)),client.on("debug",e=>console.info(e)),console.log(readJSON()),client.login(process.env.TOKEN);const http=require("http"),server=http.createServer((e,t)=>{t.writeHead(200),t.end("ok")});server.listen(3e3);