const Discord=require("discord.js"),CryptoJS=require("crypto-js"),fs=require("fs"),client=new Discord.Client;var users=[],codes=[],pics=null,removing=null;function convertMiliseconds(e){var t=parseInt(Math.floor(e/1e3)),n=parseInt(Math.floor(t/60)),o=parseInt(Math.floor(n/60)),e=parseInt(Math.floor(o/24)),t=parseInt(t%60),n=parseInt(n%60);return{d:e,h:parseInt(o%24),m:n,s:t}}function avatar(e){var t;t=null==e.mentions.users.first()?e.author:e.mentions.users.first();const n=new Discord.MessageEmbed;n.setColor(3355443),n.setAuthor(t.tag),n.setImage(t.displayAvatarURL({format:"png",dynamic:!0,size:2048})),e.channel.send(n)}function codeMsg(e){var t=randomString();codes.includes(t)&&(t=randomString());var n=pics[Math.floor(Math.random()*pics.length)];return msg1="https://www.youtube.com/watch?v=dQw4w9WgXcQ",e.author.send(msg1),e.author.send(n),t}function getDateObject(e){data=convertMiliseconds(e);return moredata=(e=>{let t=0,n=0,o=0,s=0;for(;e;)365<=e?(n++,e-=365):30<=e?(t++,e-=30):7<=e?(s++,e-=7):(o++,e--);return{years:n,months:t,weeks:s,days:o}})(data.d),{y:moredata.years,m:moredata.months,w:moredata.weeks,d:moredata.days,h:data.h,mi:data.m,s:data.s}}function timeHandler(e){return dateobj=getDateObject(e),0<dateobj.y?`Years: ${dateobj.y}, Months: ${dateobj.m}, Weeks: ${dateobj.w}, Days: ${dateobj.d}`:0<dateobj.m?`Months: ${dateobj.m}, Weeks: ${dateobj.w}, Days: ${dateobj.d}`:0<dateobj.w?`Weeks: ${dateobj.w}, Days: ${dateobj.d}, Hours: ${dateobj.h}`:0<dateobj.d?`Days: ${dateobj.d}, Hours: ${dateobj.h}, Minutes: ${dateobj.mi}`:0<dateobj.h?`Hours: ${dateobj.h}, Minutes: ${dateobj.mi}, Seconds: ${dateobj.s}`:`Minutes: ${dateobj.mi}, Seconds: ${dateobj.s}`}function help(e,t){const n=new Discord.MessageEmbed;n.setColor("#0099ff"),n.setTitle("Events Bot Help"),n.setURL("https://www.youtube.com/watch?v=dQw4w9WgXcQ"),n.setAuthor(e.author.tag),n.addFields({name:"\n$ping",value:"Gets the latency from message sending to message repsonse"},{name:"$av",value:"Gets the avatar of the mentioned user if they're in the server. Defaults to the person sending the msg."},{name:"$membercount",value:"Replies with the number of members in the server."},{name:"$electioninfo",value:"Returns an embed with the infomation of all present and upcoming elections."}),t&&n.addField("$code","Election command. DM's the user the election code, along with the instructions for to vote."),e.member.roles.cache.some(e=>"Bot mod"===e.name)&&(n.addField("$approve","Gives a user in the waiting room the Junior Pilot role and sends a welcome message."),n.addField("$questioning","Logs all the roles of the user, then overwrites the user's roles with the questioning role."),n.addField("$addimage","Adds a new image to the bot's reserves. Requires a file attachment.")),n.addField("$help","This command."),n.setImage(pics[Math.floor(Math.random()*pics.length)]),n.setTimestamp(),e.channel.send(n)}function electioninfo(e){const t=new Discord.MessageEmbed;t.setColor("0099ff"),t.setTitle("Election Infomation"),t.setAuthor(e.author.tag),t.addFields({name:"Currently",value:"There are no current running elections."},{name:"Future",value:"There will be a Event Manager election on April 3rd. Get in your flights and you'll be able to run!\nFurther details coming soon."}),e.channel.send(t)}function logger(e,t=!1){var n=new Date(Date.now()).toUTCString();fs.appendFileSync("log.txt",`\n${n}: ${e}`),t&&console.log(e)}function addImage(e){pics.push(e),saveJSON()}function randomString(e=64){for(var t="",n=e;0<n;--n)num=Math.floor(94*Math.random()+33),t+=String.fromCharCode(num);return t}async function ping(e){let t=await e.channel.send("Loading...");e=`:ping_pong: Pong!\nLatency is ${t.createdTimestamp-e.createdTimestamp}ms.\nAPI Latency is ${Math.round(client.ws.ping)} ms`;t.edit(e)}function filter(e){if("760831152109649940"==e.channel.id)return!1;words=e.content.split(" ");for(var t=0;t<words.length;t++)word=words[t],word=word.replace(/([^a-zA-z0-9]+)/g,"").toLowerCase(),words[t]=word;for(t=0;t<words.length;t++)if(removing.includes(words[t]))return!0;return!1}function readJSON(){var e=fs.readFileSync("json/main.json");(e=JSON.parse(e)).election.users.forEach(function(e){e=CryptoJS.AES.decrypt(e,process.env.ENCRYPTION_KEY);users.push(e.toString(CryptoJS.enc.Utf8))}),e.election.codes.forEach(function(e){e=CryptoJS.AES.decrypt(e,process.env.ENCRYPTION_KEY);codes.push(e.toString(CryptoJS.enc.Utf8))}),pics=e.images,removing=e.filterlist}function saveJSON(){var t={election:{users:[],codes:[]},images:[],filterlist:[]};t.images=pics,t.filterlist=removing,users.forEach(function(e){e=CryptoJS.AES.encrypt(e,process.env.ENCRYPTION_KEY);t.election.users.push(e.toString())}),codes.forEach(function(e){e=CryptoJS.AES.encrypt(e,process.env.ENCRYPTION_KEY);t.election.codes.push(e.toString())}),fs.writeFileSync("json/main.json",JSON.stringify(t))}function getMemberNumber(e){return e.guild.memberCount-7}function userinfo(e){return"That command isn't ready yet!"}client.on("ready",()=>{client.user.setActivity("$help | Watching the GeoFS Events Server",{type:"PLAYING"})}),client.on("guildMemberRemove",e=>{var t=new Discord.MessageEmbed;t.setColor("#d94c4c"),t.setAuthor("Member Left"),t.setDescription(`${e} ${e.user.tag}`),t.setFooter(`ID: ${e.id}`),t.setTimestamp(),client.channels.cache.get("753568398440398969").send(t)}),client.on("guildMemberAdd",e=>{existed=Date.now()-e.user.createdAt,existed=timeHandler(existed),e.roles.set(["752701923399958610","553723645265182720"]),ageembed=new Discord.MessageEmbed,ageembed.setColor("#0099ff"),ageembed.setAuthor("Member Joined"),ageembed.setDescription(`${e} ${e.user.tag}`),ageembed.addField("**Account Age**",`${existed}`),ageembed.setFooter(`ID: ${e.id}`),ageembed.setTimestamp(),client.channels.cache.get("753568398440398969").send(ageembed),client.channels.cache.get("553733333234876426").send(`Welcome to GeoFS Events ${e}! Please read the <#553929583397961740> and <#553720929063141379>, and then ping an online Elite Crew member to let you in!`)}),client.on("message",async o=>{if(!o.author.bot){await filter(o)&&(o.delete(),o.channel.send(`${o.author}, watch your language!`));try{if("<@780458120605990954>"==o.content)return o.channel.send("Hello! My command prefix is `$`\nIf you want to get a list of commands you can run `$help`")}catch(e){logger(`ERROR: ${e}`)}if(o.content.startsWith("$"))if(o.content.startsWith("$electioninfo"))electioninfo(o);else{if(o.content.startsWith("$user"))return o.channel.send(userinfo(o));if(o.content.startsWith("$addimage"))return o.member.roles.cache.has("766386531681435678")?(0<o.attachments.size&&(addImage(o.attachments.array()[0].url),await o.channel.send("Image added. Restarting."),process.exit()),o.channel.send(`${o.author}, you need to attatch an image!`)):o.channel.send(`${o.author}, you can't run that command!`);if(o.content.startsWith("$restart")||o.content.startsWith("$reload"))return"550456900861427733"==o.author.id&&(await o.channel.send("Restarting. See you soon!"),process.exit()),o.channel.send(`<@${o.author.id}>, you can't restart me!`);if(o.content.startsWith("$ping"))ping(o);else if(o.content.startsWith("$av"))avatar(o);else{if(!o.content.startsWith("$help")){if(o.content.startsWith("$membercount"))return o.channel.send(`There are ${getMemberNumber(o)} members in the server.`);if(o.content.startsWith("$code"))return o.channel.send(`${o.author}, there is no running election!`);if(o.content.startsWith("$approve")){if(o.member.roles.cache.has("766386531681435678")){if(null==o.mentions.members.first())return o.channel.send(`<@${o.author.id}>, you have to mention someone!`);let e=o.mentions.members.first();if(e.roles.cache.some(e=>"Security Check"===e.name)){e.roles.set(["553723642568114187"]);var t=`Welcome to GeoFS Events ${e}!\nWe hope you enjoy your stay!\nPlease make sure you have read <#553929583397961740> and <#553720929063141379>.\nWe organize and host events every day, so make sure to check <#756937922904850442> to keep up on events hosted for that day.\nThere are currently ${getMemberNumber(o)} people in this server.\nIf you need any help or advice, contact the Elite Crew.\nUse <#818115761843339274> to put your event ideas in and we will do it as soon as possible!\n\nCheck out and subscribe to our channel here: <https://www.youtube.com/channel/UCZhJvrv8C6mb0FXENg6uh2w>`;return client.channels.cache.get("553718744657035274").send(t),o.channel.send("User approved sucessfully")}return o.channel.send("That didn't work.")}return o.channel.send(`<@${o.author.id}>, you can't run that command!`)}if(o.content.startsWith("$questioning")){if(o.member.roles.cache.has("766386531681435678")){if(null==o.mentions.members.first())return o.channel.send(`<@${o.author.id}>, you have to mention someone!`);let n=o.mentions.members.first();if(n.roles.cache.has("766386531681435678"))return o.channel.send("That user can't be sent to the questioning room!");{let t=[],e=n.roles.member._roles;return e.forEach(function(e){e=o.guild.roles.cache.get(e);t.push(e.name)}),client.channels.cache.get("760831152109649940").send(`${n} had roles ${t.join(", ")}`),n.roles.set(["762663566531624980"]),client.channels.cache.get("767050317362757741").send(`<@${n.id}>, you've been sent to the questioning room.`),o.channel.send(`${n} has been sent to the questioning room`)}}return o.channel.send(`<@${o.author.id}>, you can't run that command!`)}return o.channel.send("Seems like that isn't a command!")}help(o,!1)}}}}),client.on("error",async e=>{await client.channels.cache.get("815629216372621373").send(`The bot ran into an error and needs to restart. ${e}`),await logger(`ERROR ${e}`,!0),process.exit(1)}),client.on("warn",e=>logger(`WARNING: ${e}`,!0)),readJSON(),client.login(process.env.TOKEN);const http=require("http"),server=http.createServer((e,t)=>{t.writeHead(200),t.end("ok")});server.listen(3e3),setInterval(()=>{logger("Still working.")},9e5);