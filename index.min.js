const Discord=require("discord.js"),client=new Discord.Client,CryptoJS=require("crypto-js"),fs=require("fs");var users=[],codes=[],pics=null,removing=null;function convertMiliseconds(e,t){var n=parseInt(Math.floor(e/1e3)),s=parseInt(Math.floor(n/60)),o=parseInt(Math.floor(s/60)),a=parseInt(Math.floor(o/24)),r=parseInt(n%60),i=parseInt(s%60),d=parseInt(o%24);switch(t){case"s":return n;case"m":return s;case"h":return o;case"d":return a;default:return{d:a,h:d,m:i,s:r}}}function avatar(e){var t;t=null==e.mentions.users.first()?e.author:e.mentions.users.first();const n=new Discord.MessageEmbed;n.setColor(3355443),n.setAuthor(t.tag),n.setImage(t.displayAvatarURL({format:"png",dynamic:!0,size:2048})),e.channel.send(n)}function codeMsg(e){var t=randomString();codes.includes(t)&&(t=randomString());var n=pics[Math.floor(Math.random()*pics.length)];return msg1=`**ELECTION INSTRUCTIONS**\nStep 1: Copy this ${"```"+t+"```"}\nStep 2: Go to this link. <https://docs.google.com/forms/d/e/1FAIpQLSfG3-Hoa0cydMMPNS3i62k_WSDiVfmnLs5jnKDfNCjcJ5_eAA/viewform>\n\nStep 3: Follow the prompts in the form`,e.author.send(msg1),e.author.send(n),t}function help(e,t){const n=new Discord.MessageEmbed;n.setColor("#0099ff"),n.setTitle("Events Bot Help"),n.setURL("https://www.youtube.com/watch?v=dQw4w9WgXcQ"),n.setAuthor(e.author.tag),n.addFields({name:"\n$ping",value:"Gets the latency from message sending to message repsonse"},{name:"$av",value:"Gets the avatar of the mentioned user if they're in the server. Defaults to the person sending the msg."},{name:"$membercount",value:"Replies with the number of members in the server."}),t&&n.addField("$code","Election command. DM's the user the election code, along with the instructions for to vote."),e.member.roles.cache.some(e=>"Bot mod"===e.name)&&(n.addField("$approve","Gives a user in the waiting room the Junior Pilot role and sends a welcome message."),n.addField("$questioning","Logs all the roles of the user, then overwrites the user's roles with the questioning role."),n.addField("$addimage","Adds a new image to the bot's reserves. Requires a file attachment.")),n.addField("$help","This command."),n.setImage(pics[Math.floor(Math.random()*pics.length)]),n.setTimestamp(),e.channel.send(n)}function randomString(e=64){for(var t="",n=e;0<n;--n)num=Math.floor(94*Math.random()+33),t+=String.fromCharCode(num);return t}async function ping(e){let t=await e.channel.send("Loading...");e=`:ping_pong: Pong!\nLatency is ${t.createdTimestamp-e.createdTimestamp}ms.\nAPI Latency is ${Math.round(client.ws.ping)} ms`;t.edit(e)}function filter(t){"760831152109649940"!=t.channel.id&&(words=t.content.split(" "),words.forEach(e=>{e=e.replace(/([^a-zA-z0-9]+)/g,"").toLowerCase();if(removing.includes(e))return t.delete(),t.channel.send(`<@${t.author.id}>, watch your language!`)}))}function readJSON(){var e=fs.readFileSync("json/main.json");return(e=JSON.parse(e)).election.users.forEach(function(e){e=CryptoJS.AES.decrypt(e,process.env.ENCRYPTION_KEY);users.push(e.toString(CryptoJS.enc.Utf8))}),e.election.codes.forEach(function(e){e=CryptoJS.AES.decrypt(e,process.env.ENCRYPTION_KEY);codes.push(e.toString(CryptoJS.enc.Utf8))}),pics=e.images,removing=e.filterlist,"JSON file read"}function saveJSON(){var t={election:{users:[],codes:[]},images:[],filterlist:[]};t.images=pics,t.filterlist=removing,users.forEach(function(e){e=CryptoJS.AES.encrypt(e,process.env.ENCRYPTION_KEY);t.election.users.push(e.toString())}),codes.forEach(function(e){e=CryptoJS.AES.encrypt(e,process.env.ENCRYPTION_KEY);t.election.codes.push(e.toString())}),fs.writeFileSync("json/main.json",JSON.stringify(t))}function getMemberNumber(){return client.guilds.cache.get("553718744233541656").memberCount-7}function getDateObject(e){data=convertMiliseconds(e);e={y:null,m:null,w:null,d:null,h:null,mi:null,s:null};return e.s=data.s,e.mi=data.m,e.h=data.h,data=(e=>{let t=0,n=0,s=0,o=0;for(;e;)365<=e?(n++,e-=365):30<=e?(t++,e-=30):7<=e?(o++,e-=7):(s++,e--);return{y:n,m:t,w:o,d:s}})(data.d),e.d=data.d,e.w=data.w,e.m=data.m,e.y=data.y,e}function timeHandler(e){return dataobj=getDateObject(e),0<dataobj.y?`Years: ${dataobj.y}, Months: ${dataobj.m}, Weeks: ${dataobj.w}, Days: ${dataobj.d}, Hours: ${dataobj.h}, Minutes: ${dataobj.mi}, Seconds: ${dataobj.s}`:0<dataobj.m?`Months: ${dataobj.m}, Weeks: ${dataobj.w}, Days: ${dataobj.d}, Hours: ${dataobj.h}, Minutes: ${dataobj.mi}, Seconds: ${dataobj.s}`:0<dataobj.w?`Weeks: ${dataobj.w}, Days: ${dataobj.d}, Hours: ${dataobj.h}, Minutes: ${dataobj.mi}, Seconds: ${dataobj.s}`:0<dataobj.d?`Days: ${dataobj.d}, Hours: ${dataobj.h}, Minutes: ${dataobj.mi}, Seconds: ${dataobj.s}`:0<dataobj.h?`Hours: ${dataobj.h}, Minutes: ${dataobj.mi}, Seconds: ${dataobj.s}`:`Minutes: ${dataobj.mi}, Seconds: ${dataobj.s}`}client.on("ready",()=>{client.user.setActivity("$help | Vote or else",{type:"PLAYING"})}),client.on("guildMemberRemove",e=>{var t=new Discord.MessageEmbed;t.setColor("#0099ff"),t.setAuthor("Member Left"),t.setDescription(`${e} ${e.user.tag}`),t.setFooter(`ID: ${e.id}`),t.setTimestamp(),client.channels.cache.get("753568398440398969").send(t)}),client.on("guildMemberAdd",e=>{existed=Date.now()-e.user.createdAt,existed=timeHandler(existed),e.roles.set(["752701923399958610","553723645265182720"]),ageembed=new Discord.MessageEmbed,ageembed.setColor("#0099ff"),ageembed.setAuthor("Member Joined"),ageembed.setDescription(`${e} ${e.user.tag}`),ageembed.addField("**Account Age**",`${existed}`),ageembed.setFooter(`ID: ${e.id}`),ageembed.setTimestamp(),client.channels.cache.get("753568398440398969").send(ageembed),client.channels.cache.get("553733333234876426").send(`Welcome to GeoFS Events ${e}! Please read the <#553929583397961740> and <#553720929063141379>, and then ping an online Elite Crew member to let you in!`)}),client.on("message",async s=>{if(!s.author.bot){await filter(s);try{s.mentions.members.first(),"780458120605990954"===s.mentions.members.first().user.id&&(newmsg="Hello! My command prefix is `$`\nIf you want to get a list of commands you can run `$help`",s.channel.send(newmsg))}catch(e){}if(s.content.startsWith("$")){if(t=!s.member.roles.cache.some(e=>"Junior Pilot"===e.name),s.content.startsWith("$restart")||s.content.startsWith("$reload"))return"550456900861427733"==s.author.id&&(await s.channel.send("Restarting. See you soon!"),process.exit()),s.channel.send(`<@${s.author.id}>, you can't restart me!`);if(s.content.startsWith("$ping"))ping(s);else if(s.content.startsWith("$av"))avatar(s);else if(s.content.startsWith("$help"))help(s,t);else{if(s.content.startsWith("$membercount")&&s.channel.send(`There are ${getMemberNumber()} members in the server.`),s.content.startsWith("$code"))return t?users.includes(s.author.id)?s.channel.send(`<@${s.author.id}>, you've already gotten a code!`):(code=codeMsg(s),codes.push(code),users.push(s.author.id),saveJSON(),s.channel.send(`<@${s.author.id}>, check your dm's for instructions!`)):s.channel.send(`<@${s.author.id}>, you can't vote right now!`);if(s.content.startsWith("$approve")){if(s.member.roles.cache.has("766386531681435678")){if(null==s.mentions.members.first())return s.channel.send(`<@${s.author.id}>, you have to mention someone!`);let e=s.mentions.members.first();if(e.roles.cache.some(e=>"Security Check"===e.name)){e.roles.set(["553723642568114187"]);var t=`Welcome to GeoFS Events ${e}!\nWe hope you enjoy your stay!\nPlease make sure you have read <#553929583397961740> and <#553720929063141379>.\nWe organize and host events every day, so make sure to check <#756937922904850442> to keep up on events hosted for that day.\nThere are currently ${getMemberNumber()} people in this server.\nIf you need any help or advice, contact the Elite Crew.\nUse <#717777238979903566> to put your event ideas in and we will do it as soon as possible!\n\nCheck out and subscribe to our channel here: <https://www.youtube.com/channel/UCZhJvrv8C6mb0FXENg6uh2w>`;return client.channels.cache.get("553718744657035274").send(t),s.channel.send("User approved sucessfully")}return s.channel.send("That didn't work.")}return s.channel.send(`<@${s.author.id}>, you can't run that command!`)}if(s.content.startsWith("$questioning")){if(s.member.roles.cache.has("766386531681435678")){if(null==s.mentions.members.first())return s.channel.send(`<@${s.author.id}>, you have to mention someone!`);let n=s.mentions.members.first();if(n.roles.cache.has("766386531681435678"))return s.channel.send("That user can't be sent to the questioning room!");{let t=[],e=n.roles.member._roles;return e.forEach(function(e){e=s.guild.roles.cache.get(e);t.push(e.name)}),client.channels.cache.get("760831152109649940").send(`${n} had roles ${t.join(", ")}`),n.roles.set(["762663566531624980"]),client.channels.cache.get("767050317362757741").send(`<@${n.id}>, you've been sent to the questioning room.`),s.channel.send(`${n} has been sent to the questioning room`)}}return s.channel.send(`<@${s.author.id}>, you can't run that command!`)}}}}}),client.on("error",e=>console.error(e)),client.on("warn",e=>console.warn(e)),client.on("debug",e=>console.info(e)),console.log(readJSON()),client.login(process.env.TOKEN);const http=require("http"),server=http.createServer((e,t)=>{t.writeHead(200),t.end("ok")});server.listen(3e3);